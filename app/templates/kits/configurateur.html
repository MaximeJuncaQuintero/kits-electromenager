{% extends "base.html" %}

{% block title %}Kits √âlectrom√©nager - Configurateur{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Introduction -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h1 class="card-title h3">Configurateur de Kits √âlectrom√©nager</h1>
                    <p class="card-text">
                        Trouvez les √©quipements parfaitement adapt√©s √† votre espace.
                        Indiquez simplement vos dimensions disponibles et votre budget,
                        nous vous proposerons le kit id√©al.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Configurateur -->
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Composez votre kit</h5>
                    <form id="kitForm" class="mt-3">
                        <!-- Budget total -->
                        <div class="mb-4">
                            <label class="form-label">Budget maximum (optionnel)</label>
                            <input type="number" class="form-control" id="budget" placeholder="Budget en ‚Ç¨">
                        </div>

                        <!-- S√©lection des produits -->
                        <div class="mb-4">
                            <h6>S√©lectionnez vos produits :</h6>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input product-select" type="checkbox" id="frigo" data-category="frigo">
                                <label class="form-check-label" for="frigo">R√©frig√©rateur</label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input product-select" type="checkbox" id="lave-linge" data-category="lave-linge">
                                <label class="form-check-label" for="lave-linge">Lave-linge</label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input product-select" type="checkbox" id="plaque" data-category="plaque">
                                <label class="form-check-label" for="plaque">Plaque de cuisson</label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input product-select" type="checkbox" id="four" data-category="four">
                                <label class="form-check-label" for="four">Four</label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input product-select" type="checkbox" id="lave-vaisselle" data-category="lave-vaisselle">
                                <label class="form-check-label" for="lave-vaisselle">Lave-vaisselle</label>
                            </div>
                        </div>

                        <!-- Dimensions pour chaque produit -->
                        <div id="dimensionsContainer">
                            <!-- Rempli dynamiquement par JavaScript -->
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Trouver mon kit</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Votre kit personnalis√©</h5>
                    <div id="kitResult" class="mt-3">
                        <p class="text-muted">
                            üëâ S√©lectionnez les appareils souhait√©s et indiquez vos contraintes d'espace.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="fixed-bottom bg-light p-3 border-top" id="saveBar" style="display: none;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-4">
                <input type="text" class="form-control" id="kitName" placeholder="Nom du kit">
            </div>
            <div class="col-md-4">
                <select class="form-control" id="kitType">
                    <option value="Studio">Studio</option>
                    <option value="T1">T1</option>
                    <option value="T2">T2</option>
                    <option value="T3">T3</option>
                    <option value="T4">T4</option>
                </select>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-success" onclick="sauvegarderKit()">
                    <i class="fas fa-save"></i> Sauvegarder le Kit
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="mb-4">
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="fas fa-home"></i> Accueil
    </a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
        <i class="fas fa-chart-line"></i> Dashboard
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dimensionsContainer = document.getElementById('dimensionsContainer');
    const productCheckboxes = document.querySelectorAll('.product-select');

    // Gestion de l'affichage des champs de dimensions
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateDimensionsFields();
        });
    });

    function updateDimensionsFields() {
        dimensionsContainer.innerHTML = '';
        productCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const category = checkbox.dataset.category;
                dimensionsContainer.innerHTML += `
                    <div class="mb-4">
                        <h6>${checkbox.nextElementSibling.textContent}</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="number" class="form-control" 
                                    name="${category}-largeur" 
                                    placeholder="Largeur (cm)">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" 
                                    name="${category}-hauteur" 
                                    placeholder="Hauteur (cm)">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" 
                                    name="${category}-profondeur" 
                                    placeholder="Profondeur (cm)">
                            </div>
                        </div>
                    </div>
                `;
            }
        });
    }

    function getBadgeForKit(total, nbProduits) {
        if (nbProduits <= 3 && total < 1000) return '<span class="badge bg-info">Id√©al Studio</span>';
        if (nbProduits >= 4 && total < 2000) return '<span class="badge bg-success">Parfait T2/T3</span>';
        return '<span class="badge bg-primary">Premium</span>';
    }

    function calculateMonthlyPrice(total) {
        // Environ 3% du prix total par mois sur 36 mois
        return (total * 0.03).toFixed(2);
    }

    function calculateSavings(total) {
        // Estimation des √©conomies vs achat s√©par√© (environ 15%)
        return (total * 0.15).toFixed(2);
    }

    // Soumission du formulaire
    document.getElementById('kitForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            budget: document.getElementById('budget').value,
            produits: {}
        };

        productCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const category = checkbox.dataset.category;
                formData.produits[category] = {
                    largeur: document.querySelector(`[name="${category}-largeur"]`).value,
                    hauteur: document.querySelector(`[name="${category}-hauteur"]`).value,
                    profondeur: document.querySelector(`[name="${category}-profondeur"]`).value
                };
            }
        });

        try {
            const response = await fetch('/api/kit/configurer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            displayKitResult(result);
        } catch (error) {
            console.error('Erreur:', error);
        }
    });

    function displayKitResult(result) {
        const kitResult = document.getElementById('kitResult');
        if (!result.suggestions || Object.keys(result.suggestions).length === 0) {
            kitResult.innerHTML = '<div class="alert alert-warning">Aucune combinaison trouv√©e pour ces crit√®res.</div>';
            return;
        }

        const totalPrice = result.total;
        const nbProduits = Object.keys(result.suggestions).length;
        const monthlyPrice = calculateMonthlyPrice(totalPrice);
        const savings = calculateSavings(totalPrice);

        let html = `
            <div class="mb-4">
                ${getBadgeForKit(totalPrice, nbProduits)}
                <h4 class="mt-3">Kit personnalis√©</h4>
            </div>
        `;

        Object.entries(result.suggestions).forEach(([category, products]) => {
            if (products.length > 0) {
                const product = products[0];
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${product.nom}</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    Dimensions: ${product.largeur}x${product.hauteur}x${product.profondeur} cm
                                </small>
                            </p>
                            <p class="card-text">
                                <strong>${product.prix}‚Ç¨</strong>
                            </p>
                        </div>
                    </div>
                `;
            }
        });

        html += `
            <div class="card bg-light mt-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h5 class="mb-3">Prix total</h5>
                            <h4 class="text-primary">${totalPrice.toFixed(2)}‚Ç¨</h4>
                        </div>
                        <div class="col-md-4">
                            <h5 class="mb-3">Location mensuelle</h5>
                            <h4 class="text-success">${monthlyPrice}‚Ç¨/mois</h4>
                            <small class="text-muted">Engagement 36 mois</small>
                        </div>
                        <div class="col-md-4">
                            <h5 class="mb-3">√âconomies r√©alis√©es</h5>
                            <h4 class="text-danger">${savings}‚Ç¨</h4>
                            <small class="text-muted">vs achat s√©par√©</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info mt-4">
                <h6>‚ú® Services inclus</h6>
                <ul class="mb-0">
                    <li>Livraison et installation comprises</li>
                    <li>Garantie 3 ans pi√®ces et main d'≈ìuvre</li>
                    <li>SAV d√©di√© 7j/7</li>
                    <li>Reprise gratuite de vos anciens appareils</li>
                </ul>
            </div>
        `;

        kitResult.innerHTML = html;

        updateUI(result.suggestions);
    }

    function updateUI(suggestions) {
        // Afficher la barre de sauvegarde si des produits sont s√©lectionn√©s
        document.getElementById('saveBar').style.display = 
            Object.keys(suggestions).length > 0 ? 'block' : 'none';
    }

    function sauvegarderKit() {
        const nom = document.getElementById('kitName').value || 'Nouveau Kit';
        const type_logement = document.getElementById('kitType').value;
        
        fetch('/api/kit/sauvegarder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                nom: nom,
                type_logement: type_logement
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Rediriger vers le dashboard avec le nouveau kit
                window.location.href = '/dashboard?kit_id=' + data.kit_id;
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la sauvegarde');
        });
    }
});
</script>
{% endblock %}